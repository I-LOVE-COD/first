
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>流派渊承</title>
  <script src="plugins/d3.jsV5.js"></script>
  <script src="plugins/sankey.js"></script>
  <link rel="stylesheet" type="text/css" href="plugins/fontawesome-free-6.7.2-web/css/all.css">
  <style>
    /* 确保 html 和 body 占据整个视口高度，去除默认外边距和内边距 */
    html,
    body {
      height: 100vh;
  width: 100vw;
  margin: 0;
  padding: 0;
  overflow: hidden;
    }
    body {
      font-family: 'Arial', sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      margin: 0;
      padding: 0;
      background-image: url('background.jpg');
      background-size: 100% 100%;
      background-position: center;
      background-repeat: no-repeat;

    }
    /* 修改容器定位 */
#chart-river, #tree, #map, #sankey-container {
  position: absolute;
}
  </style>
            <!-- 主图css样式 -->
        <style>
            .node text {
      fill: black;
      opacity: 1;
    }

    .timeline-text {
      font-size: 26px;
      font-family:
        "STXingkai",
        /* Windows 标准名称 */
        "华文行楷",
        /* 中文名称 */
        "Xingkai SC",
        /* macOS/iOS 名称 */
        "STXinwei",
        /* 备用名称 */
        "KaiTi",
        /* 回退到楷体 */
        cursive;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1px;
      opacity: 1;
    }
        #tree {
      position: absolute;
      bottom: 0;
      /* 将树图容器定位到页面底部 */
      z-index: 1;
      /* 确保树图在其他元素之上 */
    }
            /* 圆圈悬浮窗样式 */
    .tooltip-circle {
      position: absolute;
      background-color: white;
      /* 使用 rgba 设置背景颜色透明度 */
      border: 1px solid #ccc;
      /* 边框 */
      display: none;
      /* 默认隐藏 */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      /* 阴影效果 */
      transition: opacity 0.3s ease, transform 0.3s ease;
      /* 动画效果 */
      pointer-events: none;
      /* 防止悬浮窗干扰鼠标事件 */
      opacity: 1;
      /* 确保悬浮窗完全不透明 */
      z-index: 100;
      /* 确保悬浮窗在河流图悬浮窗之上 */
    }

    .dynasty-line {
      stroke-width: 2;
    }

    .dynasty-line {
      transition: opacity 0.3s, stroke-width 0.3s;
    }

    .dynasty-line {
      cursor: pointer;
    }
    .fa:hover{
      cursor: pointer;
      opacity: 1;
    }
        </style>
    <!-- 河流图样式 -->
  <style>
          /* 河流图样式 */
    .river {
      fill-opacity: 0.7;
    }
    /* 河流图虚线样式 */
    .hover-line {
      stroke: #000;
      stroke-width: 1px;
      stroke-dasharray: 4, 4;
      opacity: 0;
    }

    .tooltip-river {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      /* 背景颜色 */
      border: 1px solid #ddd;
      /* 边框 */
      pointer-events: none;
      /* 防止悬浮窗干扰鼠标事件 */
      opacity: 1;
      /* 确保悬浮窗完全不透明 */
      font-size: 14px;
      /* 字体大小 */
      color: #333;
      /* 字体颜色 */
      transition: opacity 0.3s ease, transform 0.3s ease;
      /* 动画效果 */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      /* 阴影效果 */
      z-index: 1000;
      /* 确保悬浮窗在河流图之上 */
    }

    /* 悬浮窗标题样式 */
    .tooltip-river strong {
      color: #002fa8;
      /* 标题颜色 */
      font-weight: bold;
    }

    /* 悬浮窗内容样式 */
    .tooltip-river table {
      width: 100%;
      border-collapse: collapse;
    }

    .tooltip-river td {
      border-bottom: 1px solid #eee;
      /* 分隔线 */
    }

    .tooltip-river td:first-child {}

    /* 圆点样式 */
    .tooltip-river.circle {
      display: inline-block;
      border-radius: 50%;
    }

    /* 温度波动值圆点样式 */
    .tooltip-river .temp-circle {}

    #chart-river {}
    .x-axis {
      display: none;
    }
  </style>
    <!-- 桑基图样式 -->
  <style>
    .sankey-node rect {
      fill-opacity: 0.9;
      shape-rendering: crispEdges;
      stroke: #333;
      stroke-width: 1.5px;
    }

    .sankey-node text {
      font-size: 12px;
      fill: black;
      /* 改为纯黑色 */
      font-weight: bold;
      /* 加粗 */
    }

    .sankey-node-link {
      fill: none;
      stroke-opacity: 0.5;
        transition: stroke-opacity 0.3s; /* 添加过渡效果 */
    }

    .sankey-node-link:hover {
      stroke-opacity: 0.9;
      cursor: pointer;
    }

    .sankey-chart-title {
      font-size: 30px;
      font-weight: bold;
      text-anchor: middle;
      fill: #c19d3f;
      font-family:
        "STXingkai",
        /* Windows 标准名称 */
        "华文行楷",
        /* 中文名称 */
        "Xingkai SC",
        /* macOS/iOS 名称 */
        "STXinwei",
        /* 备用名称 */
        "KaiTi",
        /* 回退到楷体 */
        cursive;
    }
/* 桑基图悬浮窗样式 */
.tooltip-sankey {
  position: absolute;
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid #ddd;
  pointer-events: none;
  opacity: 0;
  font-size: 14px;
  color: #333;
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  z-index: 1000;
  max-width: 250px;
}
  </style>
    <!-- 选择框样式 -->
        <style>
        #pageSelector{
            font-size:25px;
            border-radius: 5px;
             border: 1px solid #ccc;
            padding: 8px 15px;
            font-family: "STXingkai",
        /* Windows 标准名称 */
        "华文行楷",
        /* 中文名称 */
        "Xingkai SC",
        /* macOS/iOS 名称 */
        "STXinwei",
        /* 备用名称 */
        "KaiTi",
        /* 回退到楷体 */
        cursive;;
            cursor: pointer;
            background-color: white;
        }
    </style>
</head>

<body>
  <div id="tree"></div>
  <div id="map"></div>
  <!-- 河流图与落雨图的容器 -->
  <div id="chart-river"></div>
  <div>我靠</div>
  <div id="legend-container"></div>
  <div id="sankey-container"></div>
  <!-- 添加桑基图悬浮窗 -->
<div id="sankey-tooltip" class="tooltip-sankey"></div>
  <!--下拉框 -->
    <div style="position: absolute; top: 0px; right: 0px; z-index: 1000; padding: 10px;">
        <label for="pageSelector"></label><select id="pageSelector">
                <option value="第一页.html">流派渊承</option>
                <option value="第二页.html">导引千式</option>
        <option value="第三页.html">节气养和</option>
        <option value="第四页.html">杏林春秋</option>
                <option value="首页.html">首页</option>
    </select>
</div>
<script>
    // 获取下拉框元素
    const pageSelector = document.getElementById('pageSelector');

    // 添加change事件监听器+
    pageSelector.addEventListener('change', function() {
        // 获取选中的值
        const selectedPage = this.value;

        // 如果选择了有效选项，则跳转页面
        if (selectedPage) {
            window.location.href = selectedPage;
        }
    });
</script>
  <script>
    //总的绘制函数
    function draw2() {
// 在创建 all_svg 后添加一个占满全屏的矩形
/*const all_svg = d3.select("body")
  .append("svg")
  .attr("width", "100%")
  .attr("height", "100%")
  .style("position", "fixed")  // 确保 SVG 固定在视口中
  .style("top", 0)
  .style("left", 0)
  .style("z-index", -1);  // 置于其他内容下方*/


      // 在全局作用域中定义这些变量，以便在多个函数中使用
        // 全局颜色变量
  const schoolColors = {
    "伤寒学派": "#c46960",
    "河间学派": "#416f5d",
    "易水学派": "#ee7036",
    "攻邪学派": "#c19d3f",
    "丹溪学派": "#bd9e84",
    "温病学派": "#786552",
    "温补学派": "#af689b"
  };

  const timelineColors = {
    "新石器": "#c19d3f",
    "宋朝": "#9297c8",
    "金朝": "#96b23c",
    "元朝": "#f7cb9a",
    "明朝": "#f6c1a7",
    "清朝": "#f9f8cd",
    "近代": "#c46960"
  };
      // 清除之前的绘制内容
      d3.select("#map").selectAll("*").remove();
      d3.select("#tree").selectAll("*").remove();
      d3.select("#chart-river").selectAll("*").remove();
      d3.select("#sankey-container").selectAll("*").remove();
      d3.select(".tooltip-river").remove(); // 清除河流图的悬浮窗
      d3.select(".tooltip-circle").remove(); // 清除圆点的悬浮窗
      d3.select("#legend-container").selectAll("*").remove();

      // 加载 points.json
      let pointsData = [];
      let projection; // 用于存储地图投影函数

      d3.json("data/第一页/points.json").then(function (data) {
        pointsData = data;
      }).catch(error => {
        console.error("加载points.json时出错:", error);
      });
      //找出视口的高度和宽度
      const total_width = window.innerWidth;
      const total_height = window.innerHeight;
      console.log(total_width);
      console.log(total_height);
      //绘制地图
      d3.json("data/第一页/chinaMax-geo.json").then(function (data) {
        const width = total_width * 0.5;
        const height = total_height * 0.7518;
        // 画布
        const svg = d3
          .select("#map")
          .append('svg')
          .attr('width', width)
          .attr('height', height)
          .attr("transform", "translate(" + total_width * 0.61511415 + "," +-total_height*0.1+ ")");//（原为1000，300
        const tree_svg = d3.select("#tree");

        let scale_num=Math.min(total_width *0.166455,total_height*0.333283)
        //投影方式。
         projection = d3
                .geoMercator()
                .center([total_width * 0.07, total_height*0.0313283]) // 调整中心点(原107 31)
                .scale(scale_num) // 调整缩放比例,400
                .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(projection);//使用projection => path  path(data2.features)

        const color = d3.schemeCategory10;

        console.log(data.features)
        svg
                .selectAll('g')
                .data(data.features)
                .enter()
                .append('g')
                .append('path')
                .attr('d', (d) => path(d))
                .attr('stroke', '#000')
                .attr('stroke-width', 1)
                .attr('opacity', 0.3)
                .attr('fill', 'white')
        // 添加坐标
        svg
                .selectAll('g')
                .append('text')
                .attr('font-size', 12)
                .attr('text-anchor', 'middle')
                .attr('x', d => {
                  const position = projection(d.properties.centroid || [0, 0]);
                  return position[0];
                })
                .attr('y', d => {
                  const position = projection(d.properties.centroid || [0, 0]);
                  return position[1];
                })
                .attr('dy', d => {
                  //这里为什么这么写呢，因为澳门和香港重合了，挤到一起了。
                  if (d.properties.name === '澳门') {
                    return total_width * 0.00878734622;//15
                  }
                })
        // 添加图例 - 在SVG中添加一个组
        // 添加图例 - 在SVG中添加一个组
        // 添加右上角文本
        svg.append("g")
          .append("text")
          .attr("x", width/2)  // 定位在SVG宽度80%处(右侧)
          .attr("y", height * 0.2)  // 定位在SVG高度10%处(顶部)
          .attr("text-anchor", "end")  // 文本右对齐
          .attr("font-size", "35px")  // 字体大小
          .style("font-family", "STXingkai")
          .attr("font-weight", "bold")  // 加粗
          .attr("fill", "#4D4D4D")  // 字体颜色
          .text("人文渊峙");  // 文本内容

        const legend = svg.append("g")
          .attr("class", "legend")
          .attr("transform", `translate(${width * 0.05}, ${height * 0.25})`); // 调整图例位置

        // 河流图各学派颜色图例"#c69468", "#af689b", "#bd9e84", "#c19d3f", "#bca3af", "#b7bda0", "#d6acc3"
const riverLegendItems = [
  { color: schoolColors["温病学派"], label: "温病学派" },
  { color: schoolColors["温补学派"], label: "温补学派" },
  { color: schoolColors["丹溪学派"], label: "丹溪学派" },
  { color: schoolColors["攻邪学派"], label: "攻邪学派" },
  { color: schoolColors["易水学派"], label: "易水学派" },
  { color: schoolColors["河间学派"], label: "河间学派" },
  { color: schoolColors["伤寒学派"], label: "伤寒学派" }
];
         let rect_y=total_height*0.027062//20
          let rect_width=Math.max(total_height*0.02255639,total_width*0.01054481)//18
          let rect_height=Math.max(total_height*0.02255639,total_width*0.01054481)//18
          let text_distance=Math.max(total_height*0.01879699,total_width*0.008787346)//15
        riverLegendItems.forEach((item, i) => {
          // 颜色方块
          legend.append("rect")
            .attr("x", 0)
            .attr("y", rect_y + i * rect_y)
            .attr("width", rect_width)
            .attr("height", rect_height)
            .attr("fill", item.color);

          // 标签文本
          legend.append("text")
            .attr("x", rect_width)//18
            .attr("y", rect_y + i * rect_y + text_distance)
            .attr("font-size", "15px")
            .text(item.label)
                          .style("font-family", "STKaiti")
                .style("font-size", "18px");
        });

        // 温度折线图例项 - 使用平滑曲线
        const temperatureLegend = legend.append("g")
          .attr("transform", `translate(0, ${rect_y + riverLegendItems.length * rect_y + 5})`);

        // 创建平滑的小曲线
        const lineGenerator = d3.line()
          .curve(d3.curveBasis) // 使用平滑的贝塞尔曲线
          .x(d => d[0])
          .y(d => d[1]);

        temperatureLegend.append("path")
          .attr("d", lineGenerator([
            [0, 10], // 起点 (x,y)
            [10, 0], // 控制点1
            [20, 15]  // 终点
          ]))
          .attr("stroke", "#446475")
          .attr("stroke-width", 2)
          .attr("fill", "none");

        // 温度折线标签文本 - 与曲线对齐
        temperatureLegend.append("text")
          .attr("x", 20)
          .attr("y", 9) // 与曲线中点对齐
          .attr("dy", "0.35em") // 垂直居中
          .attr("font-size", "15px")
          .text("温度波动曲线")
                        .style("font-family", "STKaiti")
                .style("font-size", "18px");
      });


      //绘制树图和时间轴
      //绘制树图
      const widthtree = total_width * 0.67193;//1205
      const heighttree = total_height*1.05; // 根据视口高度调整树图高度//1000
      const x_translate = 10; // 树图左侧距离
      const y_translate = total_height*0.6; // 树图顶部距离
      const radius =Math.max(heighttree * 0.28,widthtree * 0.19); // 树图节点半径

      const tree_svg = d3.select("#tree")
        .append("svg")
        .attr("width", widthtree)
        .attr("height", heighttree)
        .append("g")
        .attr("transform", `translate(${x_translate},${y_translate}) rotate(0)`); // 使用变量替换

      // 在创建树图SVG后添加标题
const treeTitle = tree_svg.append("g")
  .attr("transform", `translate(${widthtree / 2}, ${-heighttree * 0.47})`) // 调整位置
  .append("text")
  .attr("text-anchor", "middle")  // 文本居中对齐
  .attr("font-size", "55px")  // 字体大小
  .style("font-family", "STXingkai")

  .attr("fill", "#c19d3f")  // 字体颜色
  .text("溯古医源・流派渊承");  // 文本内容

            // 在创建树图SVG后添加标题
const treeTitle2 = tree_svg.append("g")
  .attr("transform", `translate(${100}, ${-heighttree * 0.47})`) // 调整位置
  .append("text")
  .attr("text-anchor", "middle")  // 文本居中对齐
  .attr("font-size", "35px")  // 字体大小
  .style("font-family", "STXingkai")
        .style("font-weight", "bold")

  .attr("fill", "#4D4D4D")  // 字体颜色
  .text("流派递嬗");  // 文本内容

      // 半圆径向树布局，角度范围 0 到 Math.PI（即 0 到 180 度）
      const treeLayout = d3.tree()
        .size([Math.PI, radius])
        .separation((a, b) => (a.parent === b.parent ? 2 : 3) / a.depth);

      // 定义中医七大流派名字数组
      const chineseMedicineSevenSchools = [
        "伤寒学派",
        "河间学派",
        "攻邪学派",
        "易水学派",
        "丹溪学派",
        "温补学派",
        "温病学派"
      ];

      // 存储所有流派的数据
      const allData = {
        name: " ",
        children: []
      };

      // 并行加载所有 JSON 文件
      const promises = chineseMedicineSevenSchools.map(school => {
        return d3.json(`data/第一页/树图数据/${school}.json`);
      });

      Promise.all(promises)
        .then(dataArray => {
          dataArray.forEach(data => {
            allData.children.push(data);
          });

          const root = d3.hierarchy(allData);
          treeLayout(root);

          // 定义学派颜色映射"#c69468", "#af689b", "#bd9e84", "#c19d3f", "#bca3af", "#b7bda0", "#d6acc3"]);
          // 辅助函数：获取节点的学派颜色
          function getSchoolColor(node) {
            // 根节点
            if (node.depth === 0) return "#ccc";
            // 第二层节点(流派节点)
            if (node.depth === 1) return schoolColors[node.data.name] || "#ccc";

            // 向上查找直到找到有学派的父节点
            let currentNode = node;
            while (currentNode.parent && !currentNode.parent.data.school && currentNode.parent.depth > 1) {
              currentNode = currentNode.parent;
            }

            // 使用父节点的学派颜色
            return schoolColors[currentNode.parent?.data?.school || currentNode.parent?.data?.name] || "#ccc";
          }

          // 绘制节点间的连线 - 修改颜色部分
          const link = tree_svg.selectAll(".link")
            .data(root.links())
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkRadial()
              .angle(d => d.x)
              .radius(d => d.y))
            .attr("data-source", d => d.source.data.name)
            .attr("data-target", d => d.target.data.name)
            .style("stroke", d => {
              // 对于根节点到第二层节点的连线，使用目标节点的学派颜色
              if (d.source.depth === 0) {
                return schoolColors[d.target.data.name] || "#ccc";
              }
              // 对于其他连线，使用源节点的学派颜色
              return getSchoolColor(d.source);
            });
// 绘制节点 - 修改颜色部分
const node = tree_svg.selectAll(".node")
  .data(root.descendants())
  .enter().append("g")
  .attr("class", "node")
  .attr("transform", d => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`);

// 存储当前激活的节点
let activeNode = null;

node.append("circle")
  .attr("r", 3)
  .attr("data-id", d => d.data.name)
  .style("fill", d => getSchoolColor(d))
  .style("stroke", d => getSchoolColor(d))
  .style("stroke-width", 2)
  .style("cursor", "pointer")
  // 修改树图第二层节点的点击事件处理函数
.on("click", function(d) {
  if (d.depth === 1) { // 第二层节点
    const clickedNode = d3.select(this);
    const schoolName = d.data.name;

    // 如果点击的是已激活的节点
    if (activeNode === schoolName) {
      // 恢复原效果
      clickedNode
        .style("opacity", 1)
        .style("stroke-width", 2);

      // 移除地图上的圆点
      d3.select("#map svg").selectAll(".school-point").remove();

      // 恢复河流图所有河流的透明度
      d3.selectAll(".river").style("opacity", 0.7);

      // 恢复桑基图所有连线和文字的透明度
      d3.selectAll(".sankey-node-link").style("opacity", 1);
      d3.selectAll(".sankey-node text").style("opacity", 1);
      d3.selectAll(".sankey-node rect").style("opacity", 1);

      // 重置激活节点
      activeNode = null;
    }
    // 如果点击的是新节点
    else {
      // 先恢复之前激活的节点（如果有）
      if (activeNode) {
        d3.selectAll(".node circle")
          .filter(node => node.data.name === activeNode)
          .style("opacity", 1)
          .style("stroke-width", 2);
      }

      // 设置新激活节点
      activeNode = schoolName;

      // 高亮当前节点
      clickedNode
        .style("opacity", 0.8)
        .style("stroke-width", 16);

      // 获取流派名称的前两个字（用于匹配points.json）
      const schoolShortName = d.data.name.substring(0, 2);
      const schoolPoints = pointsData.filter(point =>
        point.info.liupai === schoolShortName
      );

      // 获取地图SVG
      const mapSvg = d3.select("#map svg");

      // 移除之前可能存在的圆点和雷达效果
      mapSvg.selectAll(".school-point, .scan-circle").remove();

      // 添加新的圆点
      schoolPoints.forEach(point => {
        mapSvg.append("circle")
          .attr("class", "school-point")
          .attr("cx", projection(point.position)[0])
          .attr("cy", projection(point.position)[1])
          .attr("r", 4) // 圆点大小
          .attr("fill", schoolColors[d.data.name] || "#ccc") // 使用完整流派名称获取颜色
          .attr("stroke", "#000")
          .attr("stroke-width", 1)
          .attr("opacity", 0.8)
          .append("title") // 添加提示信息
          .text(`${point.info.name} (${point.info.dynasty}, ${point.info.position})`);
      });

      // 高亮河流图中对应学派的河流
      d3.selectAll(".river")
        .style("opacity", 0.3) // 先降低所有河流的透明度
        .filter(d => d.key === schoolName)
        .style("opacity", 1); // 高亮当前学派

      // 高亮桑基图中对应学派的连线和节点
      d3.selectAll(".sankey-node-link")
        .style("opacity", 0.1) // 先降低所有连线的透明度
        .filter(d => d.source.school === schoolName || d.target.school === schoolName)
        .style("opacity", 1); // 高亮当前学派相关连线

      // 高亮桑基图中对应学派的节点文字和矩形
      d3.selectAll(".sankey-node text")
        .style("opacity", function(d) {
          return d.school === schoolName ? 1 : 0.3;
        })
        .style("font-weight", function(d) {
          return d.school === schoolName ? "bold" : "normal";
        });

      d3.selectAll(".sankey-node rect")
        .style("opacity", function(d) {
          return d.school === schoolName ? 1 : 0.3;
        });
    }
  }
});
let node_text_size=total_height*0.0151898;
          // 为节点添加文本标签
          node.append("text")
            .attr("dy", ".35em") // 设置文本的垂直偏移量
            .attr("x", d => {
              // 根据节点的位置（左半圆或右半圆）调整文本的水平偏移量
              if (d.x < Math.PI / 2) {
                return total_width * 0.00585823; // 左半圆的节点文本向左偏移 10px
              } else {
                return total_width * 0.00585823; // 右半圆的节点文本向右偏移 10px
              }
            })
            .style("text-anchor", d => {
              // 根据节点的位置（左半圆或右半圆）调整文本的对齐方式
              if (d.x < Math.PI / 2) {
                return "start"; // 左半圆的节点文本右对齐
              } else {
                return "start"; // 右半圆的节点文本左对齐
              }
            })
            .attr("transform", d => {
              // 对于右半圆的节点，旋转文本 180 度，确保文本方向正确
              if (d.x > Math.PI / 2) {
                return null; // 旋转 180 度
              }
              return null; // 左半圆的节点不需要旋转
            })
            .text(d => d.data.name) // 设置文本内容为节点的名称
            .attr("data-id", d => d.data.name)
            .style("font-family", "STKaiti")
              .style("font-size",node_text_size)// 添加唯一标识

          // 创建时间轴
          // 创建时间轴
          const dynasties = ["新石器", "宋朝", "金朝", "元朝", "明朝", "清朝", "近代"];
          const dynastyCirclePositions = {}; // 存储大圆的圆心位置
          const radiusPattern = [
            //新石器（1大加1小）
            total_height * 0.04135338345, // 大圆
            total_height * 0.01253132832, // 小圆1
            // 宋朝组 (1大 + 4小)
            total_height * 0.04135338345, // 大圆
            total_height * 0.01253132832, // 小圆1
            total_height * 0.01253132832, // 小圆2

            // 金朝组 (1大+1小)
            total_height * 0.04135338345, // 大圆
            total_height * 0.01253132832, // 小圆1

            // 元朝组 (1大 + 2小)
            total_height * 0.04135338345, // 大圆
            total_height * 0.01253132832, // 小圆1
            total_height * 0.01253132832, // 小圆1

            // 明朝组 (1大 + 4小)
            total_height * 0.04135338345, // 大圆
            total_height * 0.01253132832, // 小圆1
            total_height * 0.01253132832, // 小圆2
            total_height * 0.01253132832, // 小圆3

            // 清朝组 (1大 + 4小)
            total_height * 0.04135338345, // 大圆
            total_height * 0.01253132832, // 小圆1
            total_height * 0.01253132832, // 小圆2

            //近代（1大加1小）
            total_height * 0.04135338345, // 大圆
            total_height * 0.01253132832, // 小圆1
            total_height * 0.01253132832, // 小圆1
          ];
          // 创建时间轴的 g 标签
          const timelineX = total_width * 0.410076157;//700
          const Y = total_width * 0.029291154;//50
          const timelineY =-heighttree*0.45;
          const timeline = tree_svg.append("g")
            .attr("class", "timeline")
            .attr("transform", `translate(${timelineX},${timelineY})rotate(90)`);

          // 生成时间轴圆圈
          let currentX = 0;
          let radiusIndex = 0;

          dynasties.forEach((dynasty, i) => {
            const color =timelineColors[dynasty];

            // 确定当前朝代需要多少个圆
            let circleCount;
            if (dynasty === "宋朝") {
              circleCount = 3; // 1大 + 4小
            }
            else if (dynasty === "新石器") {
              circleCount = 2;
            }
            else if (dynasty === "金朝") {
              circleCount = 2;
            }
            else if (dynasty === "元朝") {
              circleCount = 3;
            }
            else if (dynasty === "明朝") {
              circleCount = 4;
            }
            else if (dynasty === "清朝") {
              circleCount = 3;
            }
            else if (dynasty === "近代") {
              circleCount = 3;
            }
            // 取出对应的半径值
            const radii = radiusPattern.slice(radiusIndex, radiusIndex + circleCount);
            radiusIndex += circleCount;

            radii.forEach((r, j) => {
              const xPosition = currentX + r;
              console.log(xPosition);
              timeline.append("circle")
                .attr("cx", xPosition)
                .attr("cy", 0)
                .attr("r", r)
                .attr("fill", color)
                .attr("stroke", "#000")
                .attr("stroke-width", 1);

              // 在大圆圈中心添加朝代名称
              if (r ===total_height * 0.04135338345) {
    const textElement = timeline.append("text")
        .attr("class", "timeline-text")
        .attr("x", xPosition)
        .attr("y", 0)
        .attr("dy", "0.5em")
        .attr("text-anchor", "middle")
        .attr("fill", "#000")
        .attr("transform", `rotate(-90, ${xPosition}, 0)`)
        .text(dynasty);

    // 单独设置"新石器"的字体大小
    if (dynasty === "新石器") {
        textElement.style("font-size", "22px");
    } else {
        textElement.style("font-size", "25px");
    }

                // 添加大圆的鼠标交互
                if (r ===total_height * 0.04135338345) {
                  // 修改大圆圈的鼠标交互代码
                  timeline.append("circle")
                    .attr("cx", xPosition)
                    .attr("cy", 0)
                    .attr("r", r)
                    .attr("fill", "transparent")
                    .attr("stroke", "none")
                    .attr("data-dynasty", dynasty)
                    .on("mouseover", function () {
                      const currentDynasty = d3.select(this).attr("data-dynasty");

                      // 首先将所有连线透明度降低
                      d3.selectAll(".dynasty-line")
                        .style("opacity", 0.1)
                        .style("stroke-width", 2);

                      // 然后只高亮当前朝代的连线
                      d3.selectAll(".dynasty-line")
                        .filter(function () {
                          return d3.select(this).attr("data-dynasty") === currentDynasty;
                        })
                        .style("opacity", 1)
                        .style("stroke-width", 3);

                      // 高亮树图中对应的节点和连线
                      const relatedNodes = root.descendants().filter(d => d.data.dynasty === currentDynasty);

                      // 首先降低所有节点的透明度
                      d3.selectAll(".node circle, .node text, .link")
                        .style("opacity", 0.5);

                      // 高亮从当前节点到根节点的路径
                      relatedNodes.forEach(node => {
                        // 高亮当前节点
                        d3.selectAll(`.node circle[data-id="${node.data.name}"]`)
                          .style("opacity", 1)
                          .style("stroke-width", 2);

                        d3.selectAll(`.node text[data-id="${node.data.name}"]`)
                          .style("opacity", 1)
                          .style("font-weight", "bold");

                        // 高亮到根节点的路径
                        let currentNode = node;
                        while (currentNode.parent) {
                          // 高亮父节点
                          d3.selectAll(`.node circle[data-id="${currentNode.parent.data.name}"]`)
                            .style("opacity", 1)
                            .style("stroke-width", 4);

                          d3.selectAll(`.node text[data-id="${currentNode.parent.data.name}"]`)
                            .style("opacity", 1)
                            .style("font-weight", "bold");

                          // 高亮连接线
                          d3.selectAll(".link")
                            .filter(d => d.target.data.name === currentNode.data.name && d.source.data.name === currentNode.parent.data.name)
                            .style("opacity", 1)
                            .style("stroke-width", 2);

                          currentNode = currentNode.parent;
                        }
                      });
                    })
                    .on("mouseout", function () {
                      // 恢复所有元素的默认状态
                      d3.selectAll(".dynasty-line")
                        .style("opacity", 0.8)
                        .style("stroke-width", 2);

                      // 恢复所有节点和连线的默认透明度
                      d3.selectAll(".node circle, .node text, .link")
                        .style("opacity", 1)
                        .style("stroke-width", 2)
                        .style("font-weight", "normal");

                      // 恢复链接的默认宽度
                      d3.selectAll(".link")
                        .style("stroke-width", 1);
                    });
                }

                dynastyCirclePositions[dynasty] = {
                  x: total_width*0.392501464,
                  y: xPosition -total_height*0.46766917
                };
              }
              currentX += r * 2;
            });
          });
          console.log(dynastyCirclePositions);
          // 为第四层节点添加连线到时间轴
          const fourthLayerNodes = root.descendants().filter(d => d.depth === 3); // 获取第四层节点
          fourthLayerNodes.forEach(node => {
            const dynasty = node.data.dynasty; // 获取节点的朝代属性
            if (dynasty && dynastyCirclePositions[dynasty]) {
              // 获取当前节点的文本元素
              const textElement = tree_svg.selectAll(".node text").filter(d => d.data === node.data);

              // 获取文本的宽度
              const textLength = textElement.node().getComputedTextLength();
              // 判断文本是否旋转了180度
              const isRotated = node.x >= Math.PI / 2;

              // 计算文本的末尾位置（极坐标）
              const textEndAngle = node.x; // 文本的角度
              const textEndRadius = node.y + textLength + total_width * 0.00585823; // 文本的半径

              // 将极坐标转换为笛卡尔坐标
              const [textEndX, textEndY] = d3.pointRadial(textEndAngle, textEndRadius);

              // 时间轴上对应朝代的坐标
              const sourceX = dynastyCirclePositions[dynasty].x;
              const sourceY = dynastyCirclePositions[dynasty].y;

              // 使用 d3.curveBasis 生成带有控制点的曲线
              const lineGenerator = d3.line()
                .curve(d3.curveBasis) // 使用 curveBasis 生成平滑曲线
                .x(d => d.x)
                .y(d => d.y);

              // 定义曲线的起点、控制点和终点
              let curveData;
              if (dynasty === "清朝") {
                // 清朝的特殊控制点
                curveData = [
                  { x: sourceX, y: sourceY }, // 起点
                  { x: sourceX / 2 * 1.5, y: sourceY }, // 控制点1
                  {
                    x: textEndX + total_width * 0.029291154,
                    y: textEndY * 1.3 + total_width * 0.029291154 - 100
                  }, // 控制点2，常数为50
                  { x: textEndX, y: textEndY } // 终点
                ];
              } else if (dynasty === "明朝") {
                // 明朝的特殊控制点
                curveData = [
                  { x: sourceX, y: sourceY }, // 起点
                  { x: sourceX / 2 * 1.5, y: sourceY }, // 控制点1
                  {
                    x: textEndX + total_width * 0.029291154,
                    y: textEndY * 1.3 - total_width * 0.029291154
                  }, // 控制点2，常数为50
                  { x: textEndX, y: textEndY } // 终点
                ];
              }
               else if (dynasty === "宋朝") {
                // 明朝的特殊控制点
                curveData = [
                  { x: sourceX, y: sourceY }, // 起点
                  { x: sourceX / 2 * 1.5, y: sourceY }, // 控制点1
                  {
                    x: textEndX + total_width * 0.029291154,
                    y: textEndY * 1.3 - total_width * 0.029291154+80
                  }, // 控制点2，常数为50
                  { x: textEndX, y: textEndY } // 终点
                ];
              }else {
                // 其他朝代的默认控制点
                curveData = [
                  { x: sourceX, y: sourceY }, // 起点
                  { x: sourceX / 2 * 1.5, y: sourceY }, // 控制点1
                  { x: textEndX + total_width * 0.029291154, y: textEndY * 1.3 }, // 控制点2
                  { x: textEndX, y: textEndY } // 终点
                ];
              }


              // 绘制曲线时添加交互
              const path = tree_svg.append("path")
                .attr("class", "dynasty-line")
                .attr("d", lineGenerator(curveData))
                .attr("stroke", timelineColors[dynasty])
                .attr("stroke-width", 2)
                .attr("fill", "none")
                      .style("opacity", 0.5)
                .attr("data-name", node.data.name) // 存储节点名称
                .attr("data-dynasty", dynasty); // 存储朝代

              // 添加连线上的鼠标交互
              path.on("mouseover", function () {
                const name = d3.select(this).attr("data-name");
                const dynasty = d3.select(this).attr("data-dynasty");
                // 获取父节点的父节点的name属性
                const school = node.parent && node.parent.parent ? node.parent.parent.data.name : "未知学派";

                // 高亮当前连线
                d3.select(this)
                  .style("opacity", 1)
                  .style("stroke-width", 3);

                // 显示工具提示
                tooltipCircle
                  .style("left", (d3.event.pageX + 15) + "px")
                  .style("top", (d3.event.pageY - 30) + "px")
                  .style("display", "block")
                  .style("opacity", 1)
                  .html(`
          <strong>名称:</strong> ${name}<br>
          <strong>朝代:</strong> ${dynasty}<br>
          <strong>学派:</strong> ${school}
        `);
              })
                .on("mouseout", function () {
                  // 恢复连线默认状态
                  d3.select(this)
                    .style("opacity", 0.5)
                    .style("stroke-width", 2);

                  // 隐藏工具提示
                  tooltipCircle.style("opacity", 0).style("display", "none");
                });
            }
          });
        })
        .catch(error => {
          console.error("加载数据时出错: ", error);
        });
      //绘制河流图和温度曲线
      // 河流图与折线图的代码
      const paddingRiver = {
        top: 0,
        right: total_width * 0.11716461628,
        bottom: total_width * 0.02929115407,
        left: total_width * 0.02929115407
      };
            const chartRiver = d3.select("#chart-river");
      // 动态设置河流图的样式
      const river_top = total_height * 0.035//50
      const river_right = total_width * 0.3807850029291//650//50
      chartRiver
        .style("position", "absolute")
        .style("top", `${river_top}px`)//50
        .style("right", `${river_right}px`)//650
        .style("z-index", "100");
      const widthRiver =total_height*1.25313283;
      const heightRiver = total_width * 0.2050380785;//350
      const RiverX = heightRiver;//350
      const RiverY =total_height*0.03;
      const svgRiver = d3.select("#chart-river")
        .append("svg")
        .attr("width", heightRiver) // 交换宽度和高度
        .attr("height", widthRiver) // 交换宽度和高度
        .append("g")
        .attr("transform", `translate(${RiverX}, ${RiverY}) rotate(90)`); // 旋转90°

      // 在旋转后的SVG中添加水平排列的文本
      /*svgRiver.append("g")
        .attr("transform", `translate(${heightRiver * 0.05}, ${-0.0000000000000000000000000006}) rotate(-90)`) // 反向旋转抵消整体旋转
        .append("text")
        .attr("x", -heightRiver * 0.6)
        .attr("y", -widthRiver * 0.04)
        .attr("text-anchor", "middle")
        .style("font-family", "STXingkai")
        .attr("font-weight", "bold")
        .attr("fill", "#4D4D4D")
              .style("font-size", "35px")
        .text("流派递嬗");*/


      const tooltipRiver = d3.select("body")
        .append("div")
        .attr("class", "tooltip-river")
        .style("padding", `${total_width * 0.00878734622}px`)//15px
        .style("border-radius", `${total_width * 0.0046865846514}px`)//8px
      //定义落雨图发生的事情悬浮窗样式
      const tooltipCircle = d3.select("body")
        .append("div")
        .attr("class", "tooltip-circle");
      const circle_padding = total_width * 0.0058582308;//10px
      const circle_radius = total_width * 0.004686584;//8px
      const circle_maxwidth = total_width * 0.00585823 * 20;//200px
      tooltipCircle.style("padding", `${circle_padding}px`)
        .style("border-radius", `${circle_radius}px`)
        .style("max-width", `${circle_maxwidth}px`)
      //设置table的样式
      const tooltipStrong = d3.select(".tooltip-river strong");
      tooltipStrong
        .style("margin-top", `${total_width * 0.005858230814}px`) // 设置边距，10px

      //设置td的样式
      const tooltipTd = d3.select(".tooltip-river td");//设置td的样式
      tooltipTd.style("padding", `${total_width * 0.005858230814}px 0`)//5px和0px
      //设置圆点的的列宽
      const tooltipfirst = d3.select(".tooltip-river td:first-child");
      tooltipfirst.style("width", `${total_width * 0.01171646162}px`)//20px

      const hoverLineXRiver = svgRiver.append("line")
        .attr("class", "hover-line")
        .attr("x1", 0)
        .attr("x2", widthRiver)
        .attr("y1", 0)
        .attr("y2", 0);

      const hoverLineYRiver = svgRiver.append("line")
        .attr("class", "hover-line")
        .attr("x1", 0)
        .attr("x2", 0)
        .attr("y1", 0)
        .attr("y2", heightRiver);

      d3.json("data/第一页/river_data.json").then(riverData => {
        const formattedRiverData = riverData.map(d => ({
          x: +d.x,
          温病学派: +d.温病学派,
          温补学派: +d.温补学派,
          丹溪学派: +d.丹溪学派,
          攻邪学派: +d.攻邪学派,
          易水学派: +d.易水学派,
          河间学派: +d.河间学派,
          伤寒学派: +d.伤寒学派
        }));

        d3.json("data/第一页/天气数据.json").then(rainData => {
          const formattedRainData = rainData.map(d => ({
            x: +d.x,
            y: +d.y
          }));

          const xRiver = d3.scaleLinear()
            .domain([960, 1949])
            .range([paddingRiver.left, widthRiver - paddingRiver.right*1.2]);


          const yRiver = d3.scaleLinear()
            .domain([0, 800])
            .range([heightRiver - paddingRiver.bottom, paddingRiver.top + total_width * 0.05858230814]);
          /*            const schoolColors = {
                          "伤寒学派": "#8B4513",
                          "河间学派": "#4169E1",
                          "易水学派": "#2E8B57",
                          "攻邪学派": "#9932CC",
                          "丹溪学派": "#CD5C5C",
                          "温病学派": "#FF8C00",
                          "温补学派": "#4682B4"
                      };*/
          const yRain = d3.scaleLinear()
            .domain([2, -2])
            .range([heightRiver - paddingRiver.bottom, paddingRiver.top]);
          const stack = d3.stack()
            .keys(["温病学派", "温补学派", "丹溪学派", "攻邪学派", "易水学派", "河间学派", "伤寒学派"])
            .order(d3.stackOrderNone)
            .offset(d3.stackOffsetNone);

          const stackedData = stack(formattedRiverData);

          const riverArea = d3.area()
            .x(d => xRiver(d.data.x))
            .y0(d => yRiver(d[0]))
            .y1(d => yRiver(d[1]))
            .curve(d3.curveBasis); // 添加曲线插值



//绘制河流图
const rivers = svgRiver.selectAll(".river")
  .data(stackedData)
  .enter().append("path")
  .attr("class", "river")
  .attr("d", riverArea)
  .style("fill", d => schoolColors[d.key])  // 使用全局 schoolColors
  .style("opacity", 0.7);

// 添加从左向右流动的动画
rivers.each(function() {
  const path = d3.select(this);
  const totalLength = this.getTotalLength();

  // 设置初始状态 - 完全透明且只显示最左侧
  path
    .style("stroke", path.style("fill")) // 使用填充色作为描边色
    .style("stroke-width", 2)
    .style("stroke-dasharray", totalLength + " " + totalLength)
    .style("stroke-dashoffset", totalLength)
    .style("fill-opacity", 0); // 初始填充透明

  // 执行动画
  path.transition()
    .duration(1000) // 动画持续时间2秒
    .ease(d3.easeLinear) // 线性动画
    .style("stroke-dashoffset", 0) // 描边从左向右绘制
    .on("end", function() {
      // 动画结束后显示填充区域
      d3.select(this)
              .transition()
              .duration(500)
        .style("fill-opacity", 0.7)
        .style("stroke", "none"); // 移除描边
    });
});

          // 添加折线图
          const rainLine = d3.line()
            .x(d => xRiver(d.x))
            .y(d => yRain(d.y))
            .curve(d3.curveBasis);

          svgRiver.append("path")
            .datum(formattedRainData)
            .attr("class", "rain-line")
            .attr("d", rainLine)
            .style("fill", "none")
            .style("stroke", "#446475")
            .style("stroke-width", 2);

          // 在定义 xRiver 和 yRiver 之后，创建 x 轴生成器
          const xAxisRiver = d3.axisBottom(xRiver)
            .tickValues([960, 1127, 1234, 1279, 1368, 1644, 1912]) // 设置固定的刻度值
            .tickFormat(d3.format("d")); // 设置刻度格式为整数

          // 在 svgRiver 中添加 x 轴
          svgRiver.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0, ${heightRiver - paddingRiver.bottom})`) // 将轴放置在底部
            .call(xAxisRiver);

// 加载事件数据并添加图形标记
d3.json("data/第一页/发生的事情.json").then(eventData => {
    const events = Object.values(eventData).flat(); // 将所有的流派事件合并成一个数组

    // 定义Font Awesome图标类名
    const iconClasses = {
        "战争": "fa-solid fa-swords",
        "疾病": "fa-solid fa-virus",
        "事件": "fa-solid fa-comment-dots",
        "冷期": "fa-solid fa-snowflake",
        "暖期": "fa-solid fa-fire"
    };

    // 定义颜色映射
    const iconColors = {
        "战争": "black",  // 红色
        "疾病": "#0b9b8a",  // 绿色
        "事件": "#e68815" ,  // 橙色
        "冷期": "#80daeb" ,  // 橙色
        "暖期": "#e36255"   // 橙色
    };

    events.forEach(event => {
        const year = event.time;
        const description = event.description;
        const attribute = event.Attribute;
        const iconClass = iconClasses[attribute] || iconClasses["事件"];
        const iconColor = iconColors[attribute] || iconColors["事件"];

        // 检查年份是否在 xRiver 的定义域内
        if (year >= 960 && year <= 1949) {
            const xPosition = xRiver(year);

            // 找到对应年份的落雨图数据点
            const rainPoint = formattedRainData.find(d => Math.abs(d.x - year) < 5);
            if (rainPoint) {
                const yPosition = yRain(rainPoint.y); // 使用落雨图的 y 值

                // 创建包含图标的组元素
                const iconGroup = svgRiver.append("g")
                    .attr("class", "event-icon")
                    .attr("transform", `translate(${xPosition},${yPosition + total_width * 0.03514938488})`)
                    .style("opacity", 0.8)
                    .on("mouseover", function (event) {
                        // 隐藏河流图的悬浮窗
                        tooltipRiver.style("opacity", 0);
                        // 显示圆圈悬浮窗
                        tooltipCircle
                            .style("left", `${d3.event.pageX + total_width * 0.008787346221441}px`)
                            .style("top", `${d3.event.pageY -total_width * 0.0416461}px`)
                            .style("display", "block")
                            .style("opacity", 1)
                            .html(`
                                <strong>年份:</strong> ${year}<br>
                                ${description}
                            `);
                    })
                    .on("mouseout", function () {
                        // 隐藏圆圈悬浮窗
                        tooltipCircle.style("opacity", 0);
                        tooltipCircle.style("display", "none");
                        // 重新显示河流图的悬浮窗
                        tooltipRiver.style("opacity", 1);
                    });

                // 添加Font Awesome图标（使用Unicode字符）
                // 注意：这里使用Font Awesome的Unicode字符，需要确保已加载Font Awesome CSS
                iconGroup.append("text")
                    .attr("class", "fa")
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "middle")
                    .style("font-family", "Font Awesome 6 Free")
                    .style("font-weight", "900") // Solid样式需要900
                    .style("font-size", total_width * 0.008787346221441 + "px") // 15px
                    .style("fill", iconColor)
                    .text(function() {
                        // 返回对应图标的Unicode
                        if (attribute === "战争") return "\uf024"; // fa-flag
                        if (attribute === "疾病") return "\ue4a8"; // fa-suitcase-medical
                        if (attribute === "暖期") return "\uf06d"; // fa-suitcase-medical
                        if (attribute === "冷期") return "\uf2dc"; // fa-suitcase-medical
                        return "\uf4ad"; // fa-comment-dots
                    });
            }
        }
    });
});
          svgRiver.append("rect")
            .attr("x", paddingRiver.left)
            .attr("y", paddingRiver.top)
            .attr("width", widthRiver - paddingRiver.left - paddingRiver.right)
            .attr("height", heightRiver - paddingRiver.top - paddingRiver.bottom)
            .style("fill", "none")
            .style("pointer-events", "all")
            .on("mousemove", function (event) {
              const [mouseX, mouseY] = d3.mouse(this);

              hoverLineXRiver.attr("y1", mouseY).attr("y2", mouseY).style("opacity", 1);
              hoverLineYRiver.attr("x1", mouseX).attr("x2", mouseX).style("opacity", 1);

              const xValue = xRiver.invert(mouseX);

              const riverPoint = formattedRiverData.find(d => Math.abs(d.x - xValue) < 20);
              const rainPoint = formattedRainData.find(d => Math.abs(d.x - xValue) < 20);
              window.addEventListener("load", function () {
              });


              if (riverPoint && rainPoint) {
                // 定义生成圆点的函数
                function createCircle(colorValue, width, height, margin_right) {
                  return `<span class="circle" style="display: inline-block;
width: ${width}px; height: ${height}px; border-radius: 50%; margin-right: ${margin_right}px; background-color: ${colorValue};"></span>`;
                }

                // 计算圆点的宽度和高度
                const circle_width = total_width * 0.005858230814294; // 动态计算宽度，10px
                const circle_height = circle_width;// 动态计算高度,10px
                const margin_right = total_width * 0.002929115407//5px

                //修改温度波动值圆点样式
                const temp_width = total_width * 0.005858230814294; // 动态计算宽度，10px
                const temp_margin_right = total_width * 0.002929115407//5px


                tooltipRiver
  .style("left", `${d3.event.pageX + total_width * 0.008787346221441}px`) //15
  .style("top", `${d3.event.pageY - total_width * 0.11416461}px`) //195
  .style("opacity", 1)
  .html(`
    <strong>时间:</strong> ${xValue.toFixed(0)}<br>
    <table>
      <tr>
        <td>${createCircle(schoolColors["温病学派"], circle_width, circle_height, margin_right)}</td>
        <td><strong>温病学派:</strong></td>
        <td>${riverPoint.温病学派.toFixed(2)}</td>
      </tr>
      <tr>
        <td>${createCircle(schoolColors["温补学派"], circle_width, circle_height, margin_right)}</td>
        <td><strong>温补学派:</strong></td>
        <td>${riverPoint.温补学派.toFixed(2)}</td>
      </tr>
      <tr>
        <td>${createCircle(schoolColors["丹溪学派"], circle_width, circle_height, margin_right)}</td>
        <td><strong>丹溪学派:</strong></td>
        <td>${riverPoint.丹溪学派.toFixed(2)}</td>
      </tr>
      <tr>
        <td>${createCircle(schoolColors["攻邪学派"], circle_width, circle_height, margin_right)}</td>
        <td><strong>攻邪学派:</strong></td>
        <td>${riverPoint.攻邪学派.toFixed(2)}</td>
      </tr>
      <tr>
        <td>${createCircle(schoolColors["易水学派"], circle_width, circle_height, margin_right)}</td>
        <td><strong>易水学派:</strong></td>
        <td>${riverPoint.易水学派.toFixed(2)}</td>
      </tr>
      <tr>
        <td>${createCircle(schoolColors["河间学派"], circle_width, circle_height, margin_right)}</td>
        <td><strong>河间学派:</strong></td>
        <td>${riverPoint.河间学派.toFixed(2)}</td>
      </tr>
      <tr>
        <td>${createCircle(schoolColors["伤寒学派"], circle_width, circle_height, margin_right)}</td>
        <td><strong>伤寒学派:</strong></td>
        <td>${riverPoint.伤寒学派.toFixed(2)}</td>
      </tr>
      <tr>
        <td><span class="temp-circle" style="display: inline-block; width: ${temp_width}px; height: ${temp_width}; background-color: #446475; border-radius: 50%; margin-right: ${temp_margin_right}px;"></span></td>
        <td><strong>温度波动值:</strong></td>
        <td>${rainPoint.y.toFixed(2)}℃</td>
      </tr>
    </table>
  `);
              } else {
                tooltipRiver.style("opacity", 0);
              }

            })
            .on("mouseout", function () {
              hoverLineXRiver.style("opacity", 0);
              hoverLineYRiver.style("opacity", 0);
              tooltipRiver.style("opacity", 0);
            });
        });
      });
            // 准备数据（使用原有数据）
        const graph = {
          nodes: [
            // Level 1: 学派
            { name: "伤寒学派", level: 0, school: "伤寒学派" },
            { name: "河间学派", level: 0, school: "河间学派" },
            { name: "易水学派", level: 0, school: "易水学派" },
            { name: "攻邪学派", level: 0, school: "攻邪学派" },
            { name: "丹溪学派", level: 0, school: "丹溪学派" },
            { name: "温病学派", level: 0, school: "温病学派" },
            { name: "温补学派", level: 0, school: "温补学派" },

            // Level 2: 代表人物
    { "name": "张仲景", "level": 1, "school": "伤寒学派", "dynasty": "东汉" },
    { "name": "刘完素", "level": 1, "school": "河间学派", "dynasty": "金代" },
    { "name": "张元素", "level": 1, "school": "易水学派", "dynasty": "金代" },
    { "name": "张从正", "level": 1, "school": "攻邪学派", "dynasty": "金代" },
    { "name": "朱震亨", "level": 1, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "薛己", "level": 1, "school": "温补学派", "dynasty": "明代" },
    { "name": "吴有性", "level": 1, "school": "温病学派", "dynasty": "明代" },

    // Level 3: 徒弟或间接影响
    // 伤寒学派
    { "name": "王叔和", "level": 2, "school": "伤寒学派", "dynasty": "西晋" },
    { "name": "庞安时", "level": 2, "school": "伤寒学派", "dynasty": "宋代" },
    { "name": "朱肱", "level": 2, "school": "伤寒学派", "dynasty": "宋代" },
    { "name": "成无己", "level": 2, "school": "伤寒学派", "dynasty": "金代" },
    { "name": "方有执", "level": 2, "school": "伤寒学派", "dynasty": "明代" },
    { "name": "柯琴", "level": 2, "school": "伤寒学派", "dynasty": "清代" },
    { "name": "喻昌", "level": 2, "school": "伤寒学派", "dynasty": "明末清初" },
    { "name": "尤在泾", "level": 2, "school": "伤寒学派", "dynasty": "清代" },

    // 河间学派
    { "name": "穆子昭", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "荆山浮屠", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "罗知悌", "level": 2, "school": "河间学派", "dynasty": "元代" },
    { "name": "马宗素", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "刘荣甫", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "镏洪", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "常德", "level": 2, "school": "河间学派", "dynasty": "金代" },

    // 易水学派
    { "name": "李杲", "level": 2, "school": "易水学派", "dynasty": "金代" },
    { "name": "王好古", "level": 2, "school": "易水学派", "dynasty": "元代" },
    { "name": "罗天益", "level": 2, "school": "易水学派", "dynasty": "元代" },

    // 攻邪学派
    { "name": "麻九畴", "level": 2, "school": "攻邪学派", "dynasty": "金代" },
    { "name": "李子范", "level": 2, "school": "攻邪学派", "dynasty": "金代" },
    { "name": "常仲明", "level": 2, "school": "攻邪学派", "dynasty": "金代" },

    // 丹溪学派
    { "name": "赵道霞", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "赵以得", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "戴思恭", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "汪机", "level": 2, "school": "丹溪学派", "dynasty": "明代" },
    { "name": "王履", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "刘桔泉", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "刘纯", "level": 2, "school": "丹溪学派", "dynasty": "明代" },
    { "name": "王纶", "level": 2, "school": "丹溪学派", "dynasty": "明代" },
    { "name": "虞抟", "level": 2, "school": "丹溪学派", "dynasty": "明代" },

    // 温补学派
    { "name": "赵献可", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "高鼓峰", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "董费翁", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "吕晚邨", "level": 2, "school": "温补学派", "dynasty": "明末清初" },
    { "name": "李中梓", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "沈郎仲", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "马元仪", "level": 2, "school": "温补学派", "dynasty": "清代" },

    // 温病学派
    { "name": "戴天章", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "余霖", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "叶桂", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "薛雪", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "吴瑭", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "王士雄", "level": 2, "school": "温病学派", "dynasty": "清代" }
          ],
          links: [
            // 学派 -> 代表人物
            { source: "伤寒学派", target: "张仲景", value: 10, type: "学派理论奠基人" },
            { source: "河间学派", target: "刘完素", value: 8, type: "学派理论奠基人" },
            { source: "攻邪学派", target: "张从正", value: 6, type: "学派理论奠基人" },
            { source: "易水学派", target: "张元素", value: 7, type: "学派理论奠基人" },
            { source: "丹溪学派", target: "朱震亨", value: 5, type: "学派理论奠基人" },
            { source: "温补学派", target: "薛己", value: 8, type: "学派代表人物" },
            { source: "温病学派", target: "吴有性", value: 8, type: "学派代表人物" },

            // 代表人物 -> 徒弟或间接影响
            { source: "张仲景", target: "王叔和", value: 4, type: "间接影响" },
            { source: "张仲景", target: "庞安时", value: 4, type: "间接影响" },
            { source: "张仲景", target: "朱肱", value: 4, type: "间接影响" },
            { source: "张仲景", target: "成无己", value: 4, type: "间接影响" },
            { source: "张仲景", target: "方有执", value: 4, type: "间接影响" },
            { source: "张仲景", target: "喻昌", value: 4, type: "间接影响" },
            { source: "张仲景", target: "尤在泾", value: 4, type: "间接影响" },
            { source: "张仲景", target: "柯琴", value: 4, type: "间接影响" },
            { source: "刘完素", target: "刘荣甫", value: 5, type: "师徒" },
            { source: "刘完素", target: "荆山浮屠", value: 5, type: "师徒" },
            { source: "刘完素", target: "张从正", value: 3, type: "间接影响" },
            { source: "刘完素", target: "马宗素", value: 3, type: "师徒" },
            { source: "刘完素", target: "穆子昭", value: 3, type: "师徒" },
            { source: "荆山浮屠", target: "罗知悌", value: 3, type: "师徒" },
            { source: "马宗素", target: "镏洪", value: 3, type: "师徒" },
            { source: "马宗素", target: "常德", value: 3, type: "师徒" },
            { source: "张元素", target: "李杲", value: 5, type: "师徒" },
            { source: "张元素", target: "王好古", value: 5, type: "师徒" },
            { source: "李杲", target: "罗天益", value: 5, type: "师徒" },
            { source: "张从正", target: "麻九畴", value: 5, type: "师徒" },
            { source: "张从正", target: "李子范", value: 5, type: "师徒" },
            { source: "张从正", target: "常仲明", value: 5, type: "师徒" },
            { source: "常仲明", target: "常德", value: 5, type: "师徒" },
            { source: "罗知悌", target: "朱震亨", value: 6, type: "师徒" },
            { source: "朱震亨", target: "赵道霞", value: 7, type: "师徒" },
            { source: "朱震亨", target: "赵以得", value: 5, type: "师徒" },
            { source: "朱震亨", target: "戴思恭", value: 5, type: "师徒" },
            { source: "戴思恭", target: "汪机", value: 5, type: "师徒" },
            { source: "朱震亨", target: "王履", value: 5, type: "师徒" },
            { source: "朱震亨", target: "刘桔泉", value: 5, type: "师徒" },
            { source: "刘桔泉", target: "刘纯", value: 5, type: "师徒" },
            { source: "朱震亨", target: "王纶", value: 5, type: "间接影响" },
            { source: "朱震亨", target: "虞抟", value: 5, type: "间接影响" },
            { source: "李杲", target: "薛己", value: 5, type: "间接影响" },
            { source: "薛己", target: "赵献可", value: 5, type: "间接影响" },
            { source: "赵献可", target: "高鼓峰", value: 10, type: "间接影响" },
            { source: "赵献可", target: "董费翁", value: 10, type: "间接影响" },
            { source: "赵献可", target: "吕晚邨", value: 5, type: "间接影响" },
            { source: "李杲", target: "李中梓", value: 5, type: "间接影响" },
            { source: "李中梓", target: "沈郎仲", value: 5, type: "师徒" },
            { source: "李中梓", target: "马元仪", value: 5, type: "师徒" },
            { source: "马元仪", target: "尤在泾", value: 5, type: "师徒" },
            { source: "镏洪", target: "吴有性", value: 5, type: "间接影响" },
            { source: "常德", target: "吴有性", value: 5, type: "间接影响" },
            { source: "吴有性", target: "戴天章", value: 5, type: "间接影响" },
            { source: "戴天章", target: "余霖", value: 5, type: "间接影响" },
            { source: "镏洪", target: "叶桂", value: 5, type: "间接影响" },
            { source: "常德", target: "叶桂", value: 5, type: "间接影响" },
            { source: "镏洪", target: "薛雪", value: 5, type: "间接影响" },
            { source: "常德", target: "薛雪", value: 5, type: "间接影响" },
            { source: "叶桂", target: "吴瑭", value: 5, type: "间接影响" },
            { source: "薛雪", target: "吴瑭", value: 5, type: "间接影响" },
            { source: "吴瑭", target: "王士雄", value: 5, type: "间接影响" }
          ]
        };
      //绘制桑基图
      function makeSankey() {
          const sankeyTooltip = d3.select("#sankey-tooltip");
        const sankey_width = total_width*0.35179;
        const sankey_height = total_height*0.7518796;
        const sankey_margin = { top: 0.02929*total_width, right: total_width*0.01171, bottom: total_width*0.01171, left: total_width*0.01171 };

        // 创建SVG容器
        const sankey_svg = d3.select("#sankey-container")
          .append("svg")
          .attr("width", sankey_width + sankey_margin.left + sankey_margin.right)
          .attr("height", sankey_height + sankey_margin.top + sankey_margin.bottom)
          .append("g")
          .attr("transform", `translate(${sankey_margin.left},${sankey_margin.top})`);

        const sankey_s = d3.select("#sankey-container");

        sankey_s.style("position", "absolute")
          .style("top", '40%')
          .style("right", "0%");
        // 添加标题
        sankey_svg.append("text")
          .attr("class", "sankey-chart-title")
          .attr("x", sankey_width / 2)
          .attr("y", -total_height*0.0250626)
                .style("fill",'#4D4D4D')
                .style("font-size", "35px")
          .text("学派渊流");

        // 定义桑基图布局
        const sankey = d3.sankey()
          .nodeWidth(10)
          .nodePadding(5)
          .size([sankey_width, total_height*0.463909]);
        // 准备数据（使用原有数据）
        const graph = {
          nodes: [
            // Level 1: 学派
            { name: "伤寒学派", level: 0, school: "伤寒学派" },
            { name: "河间学派", level: 0, school: "河间学派" },
            { name: "易水学派", level: 0, school: "易水学派" },
            { name: "攻邪学派", level: 0, school: "攻邪学派" },
            { name: "丹溪学派", level: 0, school: "丹溪学派" },
            { name: "温病学派", level: 0, school: "温病学派" },
            { name: "温补学派", level: 0, school: "温补学派" },

            // Level 2: 代表人物
    { "name": "张仲景", "level": 1, "school": "伤寒学派", "dynasty": "东汉" },
    { "name": "刘完素", "level": 1, "school": "河间学派", "dynasty": "金代" },
    { "name": "张元素", "level": 1, "school": "易水学派", "dynasty": "金代" },
    { "name": "张从正", "level": 1, "school": "攻邪学派", "dynasty": "金代" },
    { "name": "朱震亨", "level": 1, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "薛己", "level": 1, "school": "温补学派", "dynasty": "明代" },
    { "name": "吴有性", "level": 1, "school": "温病学派", "dynasty": "明代" },

    // Level 3: 徒弟或间接影响
    // 伤寒学派
    { "name": "王叔和", "level": 2, "school": "伤寒学派", "dynasty": "西晋" },
    { "name": "庞安时", "level": 2, "school": "伤寒学派", "dynasty": "宋代" },
    { "name": "朱肱", "level": 2, "school": "伤寒学派", "dynasty": "宋代" },
    { "name": "成无己", "level": 2, "school": "伤寒学派", "dynasty": "金代" },
    { "name": "方有执", "level": 2, "school": "伤寒学派", "dynasty": "明代" },
    { "name": "柯琴", "level": 2, "school": "伤寒学派", "dynasty": "清代" },
    { "name": "喻昌", "level": 2, "school": "伤寒学派", "dynasty": "明末清初" },
    { "name": "尤在泾", "level": 2, "school": "伤寒学派", "dynasty": "清代" },

    // 河间学派
    { "name": "穆子昭", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "荆山浮屠", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "罗知悌", "level": 2, "school": "河间学派", "dynasty": "元代" },
    { "name": "马宗素", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "刘荣甫", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "镏洪", "level": 2, "school": "河间学派", "dynasty": "金代" },
    { "name": "常德", "level": 2, "school": "河间学派", "dynasty": "金代" },

    // 易水学派
    { "name": "李杲", "level": 2, "school": "易水学派", "dynasty": "金代" },
    { "name": "王好古", "level": 2, "school": "易水学派", "dynasty": "元代" },
    { "name": "罗天益", "level": 2, "school": "易水学派", "dynasty": "元代" },

    // 攻邪学派
    { "name": "麻九畴", "level": 2, "school": "攻邪学派", "dynasty": "金代" },
    { "name": "李子范", "level": 2, "school": "攻邪学派", "dynasty": "金代" },
    { "name": "常仲明", "level": 2, "school": "攻邪学派", "dynasty": "金代" },

    // 丹溪学派
    { "name": "赵道霞", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "赵以得", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "戴思恭", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "汪机", "level": 2, "school": "丹溪学派", "dynasty": "明代" },
    { "name": "王履", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "刘桔泉", "level": 2, "school": "丹溪学派", "dynasty": "元代" },
    { "name": "刘纯", "level": 2, "school": "丹溪学派", "dynasty": "明代" },
    { "name": "王纶", "level": 2, "school": "丹溪学派", "dynasty": "明代" },
    { "name": "虞抟", "level": 2, "school": "丹溪学派", "dynasty": "明代" },

    // 温补学派
    { "name": "赵献可", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "高鼓峰", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "董费翁", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "吕晚邨", "level": 2, "school": "温补学派", "dynasty": "明末清初" },
    { "name": "李中梓", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "沈郎仲", "level": 2, "school": "温补学派", "dynasty": "明代" },
    { "name": "马元仪", "level": 2, "school": "温补学派", "dynasty": "清代" },

    // 温病学派
    { "name": "戴天章", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "余霖", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "叶桂", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "薛雪", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "吴瑭", "level": 2, "school": "温病学派", "dynasty": "清代" },
    { "name": "王士雄", "level": 2, "school": "温病学派", "dynasty": "清代" }
          ],
          links: [
            // 学派 -> 代表人物
            { source: "伤寒学派", target: "张仲景", value: 10, type: "学派理论奠基人" },
            { source: "河间学派", target: "刘完素", value: 8, type: "学派理论奠基人" },
            { source: "攻邪学派", target: "张从正", value: 6, type: "学派理论奠基人" },
            { source: "易水学派", target: "张元素", value: 7, type: "学派理论奠基人" },
            { source: "丹溪学派", target: "朱震亨", value: 5, type: "学派理论奠基人" },
            { source: "温补学派", target: "薛己", value: 8, type: "学派代表人物" },
            { source: "温病学派", target: "吴有性", value: 8, type: "学派代表人物" },

            // 代表人物 -> 徒弟或间接影响
            { source: "张仲景", target: "王叔和", value: 4, type: "间接影响" },
            { source: "张仲景", target: "庞安时", value: 4, type: "间接影响" },
            { source: "张仲景", target: "朱肱", value: 4, type: "间接影响" },
            { source: "张仲景", target: "成无己", value: 4, type: "间接影响" },
            { source: "张仲景", target: "方有执", value: 4, type: "间接影响" },
            { source: "张仲景", target: "喻昌", value: 4, type: "间接影响" },
            { source: "张仲景", target: "尤在泾", value: 4, type: "间接影响" },
            { source: "张仲景", target: "柯琴", value: 4, type: "间接影响" },
            { source: "刘完素", target: "刘荣甫", value: 5, type: "师徒" },
            { source: "刘完素", target: "荆山浮屠", value: 5, type: "师徒" },
            { source: "刘完素", target: "张从正", value: 3, type: "间接影响" },
            { source: "刘完素", target: "马宗素", value: 3, type: "师徒" },
            { source: "刘完素", target: "穆子昭", value: 3, type: "师徒" },
            { source: "荆山浮屠", target: "罗知悌", value: 3, type: "师徒" },
            { source: "马宗素", target: "镏洪", value: 3, type: "师徒" },
            { source: "马宗素", target: "常德", value: 3, type: "师徒" },
            { source: "张元素", target: "李杲", value: 5, type: "师徒" },
            { source: "张元素", target: "王好古", value: 5, type: "师徒" },
            { source: "李杲", target: "罗天益", value: 5, type: "师徒" },
            { source: "张从正", target: "麻九畴", value: 5, type: "师徒" },
            { source: "张从正", target: "李子范", value: 5, type: "师徒" },
            { source: "张从正", target: "常仲明", value: 5, type: "师徒" },
            { source: "常仲明", target: "常德", value: 5, type: "师徒" },
            { source: "罗知悌", target: "朱震亨", value: 6, type: "师徒" },
            { source: "朱震亨", target: "赵道霞", value: 7, type: "师徒" },
            { source: "朱震亨", target: "赵以得", value: 5, type: "师徒" },
            { source: "朱震亨", target: "戴思恭", value: 5, type: "师徒" },
            { source: "戴思恭", target: "汪机", value: 5, type: "师徒" },
            { source: "朱震亨", target: "王履", value: 5, type: "师徒" },
            { source: "朱震亨", target: "刘桔泉", value: 5, type: "师徒" },
            { source: "刘桔泉", target: "刘纯", value: 5, type: "师徒" },
            { source: "朱震亨", target: "王纶", value: 5, type: "间接影响" },
            { source: "朱震亨", target: "虞抟", value: 5, type: "间接影响" },
            { source: "李杲", target: "薛己", value: 5, type: "间接影响" },
            { source: "薛己", target: "赵献可", value: 5, type: "间接影响" },
            { source: "赵献可", target: "高鼓峰", value: 10, type: "间接影响" },
            { source: "赵献可", target: "董费翁", value: 10, type: "间接影响" },
            { source: "赵献可", target: "吕晚邨", value: 5, type: "间接影响" },
            { source: "李杲", target: "李中梓", value: 5, type: "间接影响" },
            { source: "李中梓", target: "沈郎仲", value: 5, type: "师徒" },
            { source: "李中梓", target: "马元仪", value: 5, type: "师徒" },
            { source: "马元仪", target: "尤在泾", value: 5, type: "师徒" },
            { source: "镏洪", target: "吴有性", value: 5, type: "间接影响" },
            { source: "常德", target: "吴有性", value: 5, type: "间接影响" },
            { source: "吴有性", target: "戴天章", value: 5, type: "间接影响" },
            { source: "戴天章", target: "余霖", value: 5, type: "间接影响" },
            { source: "镏洪", target: "叶桂", value: 5, type: "间接影响" },
            { source: "常德", target: "叶桂", value: 5, type: "间接影响" },
            { source: "镏洪", target: "薛雪", value: 5, type: "间接影响" },
            { source: "常德", target: "薛雪", value: 5, type: "间接影响" },
            { source: "叶桂", target: "吴瑭", value: 5, type: "间接影响" },
            { source: "薛雪", target: "吴瑭", value: 5, type: "间接影响" },
            { source: "吴瑭", target: "王士雄", value: 5, type: "间接影响" }
          ]
        };

        // 将名称引用转换为索引引用
        const nodeMap = {};
        graph.nodes.forEach((node, i) => {
  nodeMap[node.name] = i;
  node.color = schoolColors[node.school] || "#ccc";  // 使用全局 schoolColors
        });

        // 关键修改1：添加 fixedWidth 并手动设置连线宽度
        const formattedLinks = graph.links.map(link => {
          const sourceNode = graph.nodes[nodeMap[link.source]];
          return {
            source: nodeMap[link.source],
            target: nodeMap[link.target],
            value: link.value,  // 保留但不用于宽度
            type: link.type,
            color: sourceNode.color,
            fixedWidth: link.type.includes("学派") ? 4 :  // 手动设置宽度
              link.type === "师徒" ? 2 :
                2
          };
        });

        const formattedGraph = {
          nodes: graph.nodes,
          links: formattedLinks
        };


        // 计算桑基图布局
        const layoutGraph = sankey(formattedGraph);

 sankey_svg.append("g")
    .selectAll(".link")
    .data(layoutGraph.links)
    .enter().append("path")
    .attr("class", "sankey-node-link")
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke-width", d => d.fixedWidth)
    .style("stroke", d => d.color)
    .style("stroke-dasharray", d => d.type === "间接影响" ? "5,3" : "0")
         .style("opacity",0.7)
    .on("mouseover", function(d) {
      sankeyTooltip
        .style("left", (d3.event.pageX - sankeyTooltip.node().offsetWidth) + "px")  // 左侧对齐
    .style("top", (d3.event.pageY - sankeyTooltip.node().offsetHeight) + "px")  // 上方对齐
        .style("opacity", 1)
        .html(`
          <strong>来源:</strong> ${d.source.name}→${d.target.name}<br>
          <strong>关系类型:</strong> ${d.type}<br>
          <strong>学派:</strong> ${d.source.school}
        `);
    })
    .on("mouseout", function() {
      sankeyTooltip.style("opacity", 0);
    });

  // 修改节点部分的代码，移除title标签，添加悬浮窗交互
  const sankey_node = sankey_svg.append("g")
    .selectAll(".sankey-node")
    .data(layoutGraph.nodes)
    .enter().append("g")
    .attr("class", "sankey-node")
    .attr("transform", d => `translate(${d.x0},${d.y0})`);

  sankey_node.append("rect")
    .attr("height", d => d.y1 - d.y0)
    .attr("width", sankey.nodeWidth())
    .attr("fill", d => d.color)
    .on("mouseover", function(d) {
      sankeyTooltip
        .style("left", (d3.event.pageX - sankeyTooltip.node().offsetWidth) + "px")  // 左侧对齐
    .style("top", (d3.event.pageY - sankeyTooltip.node().offsetHeight) + "px")  // 上方对齐
        .style("opacity", 1)
        .html(`
          <strong>名称:</strong> ${d.name}<br>
          <strong>学派:</strong> ${d.school}<br>
          <strong>朝代:</strong> ${d.dynasty}
        `);
    })
    .on("mouseout", function() {
      sankeyTooltip.style("opacity", 0);
    });

        sankey_node.append("text")
          .attr("x", d => d.x0 < sankey_width / 2 ? sankey.nodeWidth() + 6 : -6)
          .attr("y", d => (d.y1 - d.y0) / 2)
          .attr("dy", "0.35em")
          .attr("text-anchor", d => d.x0 < sankey_width / 2 ? "start" : "end")
          .text(d => d.name)
                .style("font-family", "STKaiti")
                .style("font-size", "15px")
        // 在 makeSankey() 函数末尾添加以下代码

// 创建图例容器
const legend = sankey_svg.append("g")
  .attr("class", "sankey-legend")
.attr("transform", `translate(${total_width * 0.1}, ${total_height * 0.4})`); // 使用动态计算的位置

// 添加连线类型图例
const linkTypes = [
  { label: "学派理论奠基人", width: 4, dash: "0", color: "black" },
  { label: "师徒关系", width: 2, dash: "0", color: "black" },
  { label: "间接影响", width: 2, dash: "5,3", color: "black" }
];

// 添加连线类型图例
linkTypes.forEach((type, i) => {
  // 添加示例线
  legend.append("path")
    .attr("d", `M0,${i * 25 + 5} L40,${i * 25 + 5}`)
    .attr("stroke", type.color)
    .attr("stroke-width", type.width)
    .attr("stroke-dasharray", type.dash);

  // 添加文本
  legend.append("text")
    .attr("x", 50)
    .attr("y", i * 25 + 10)
    .attr("dy", "0.35em")
    .text(type.label)
    .style("font-family", "STKaiti")
    .style("font-size", "20px");
});

// 添加事件图标图例
const eventTypes = [
  { label: "战争", icon: "\uf024", color: "black" },
  { label: "疾病", icon: "\ue4a8", color: "#0b9b8a" },
  { label: "事件", icon: "\uf4ad", color: "#e68815" },
  { label: "暖期", icon: "\uf06d", color: "#e36255" },
  { label: "冷期", icon: "\uf2dc", color: "#80daeb" }
];

// 在右侧添加事件图标图例
const eventLegend = sankey_svg.append("g")
  .attr("class", "event-legend")
  .attr("transform", `translate(0, ${total_height*0.375})`);


    let text_y=total_height*0.031328//25
    let text_x=total_width*0.0117164//20
    let text_distance=total_height*0.012531//10

eventTypes.forEach((type, i) => {
  // 添加图标
  eventLegend.append("text")
    .attr("class", "fa")
    .attr("x", 0)
    .attr("y", i * text_y + text_distance)
    .attr("dy", "0.35em")
    .style("font-family", "Font Awesome 6 Free")
    .style("font-weight", "900")
    .style("font-size", "20px")
    .style("fill", type.color)
    .text(type.icon);

  eventLegend.append("text")
    .attr("x", text_x)
    .attr("y", i * text_y + text_distance)
    .attr("dy", "0.35em")
    .text(type.label)
    .style("font-family", "STKaiti")
    .style("font-size", "18px");
});

// 添加图例标题
/*legend.append("text")
  .attr("x", 0)
  .attr("y", -10)
  .text("连线类型:")
  .style("font-family", "STKaiti")
  .style("font-size", "20px")
  .style("font-weight", "bold");*/

/*eventLegend.append("text")
  .attr("x", 0)
  .attr("y", -10)
  .text("事件图标:")
  .style("font-family", "STKaiti")
  .style("font-size", "20px")
  .style("font-weight", "bold");*/
      }
      makeSankey();
    }
    draw2();
    // 监听浏览器窗口大小变化
    window.addEventListener("resize", function () {
      // 隐藏悬浮窗
      d3.select(".tooltip-river").style("opacity", 0);
      d3.select(".tooltip-circle").style("opacity", 0);
      // 重新绘制图形
      draw2();
    });
  </script>
</body>

</html>
